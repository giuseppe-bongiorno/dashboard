name Deploy Frontend

on
  push
    branches [ test ]
  workflow_dispatch

jobs
  deploy
    runs-on ubuntu-latest
    
    steps
    # 1. Checkout code
    - name ğŸ“¥ Checkout code
      uses actionscheckout@v4

    # 2. Setup Node.js
    - name ğŸ”§ Setup Node.js
      uses actionssetup-node@v4
      with
        node-version '20'
        cache 'npm'

    # 3. Install dependencies
    - name ğŸ“¦ Install dependencies
      run npm ci

    # 4. Build
    - name ğŸ”¨ Build
      run npm run build

    # 5. Display build output
    - name ğŸ“Š Display build output
      run 
        echo Build completed!
        ls -la dist

    # 6. Deploy to server via SSH
    - name ğŸš€ Deploy to server
      uses appleboyssh-action@master
      with
        host ${{ secrets.SERVER_HOST }}
        username ${{ secrets.SERVER_USER }}
        key ${{ secrets.SSH_PRIVATE_KEY }}
        script 
          # Backup precedente
          if [ -d varwwwmyfamilydoc ]; then
            sudo cp -r varwwwmyfamilydoc varwwwmyfamilydoc.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # Pulisci directory temporanea
          rm -rf tmpfrontend-deploy
          mkdir -p tmpfrontend-deploy

    # 7. Copy files to server
    - name ğŸ“¤ Copy files to server
      uses appleboyscp-action@master
      with
        host ${{ secrets.SERVER_HOST }}
        username ${{ secrets.SERVER_USER }}
        key ${{ secrets.SSH_PRIVATE_KEY }}
        source dist
        target tmpfrontend-deploy
        strip_components 1

    # 8. Move files to final location
    - name ğŸ“‚ Move files to web directory
      uses appleboyssh-action@master
      with
        host ${{ secrets.SERVER_HOST }}
        username ${{ secrets.SERVER_USER }}
        key ${{ secrets.SSH_PRIVATE_KEY }}
        script 
          # Crea directory se non esiste
          sudo mkdir -p varwwwmyfamilydoc
          
          # Copia nuovi file
          sudo cp -r tmpfrontend-deploy varwwwmyfamilydoc
          
          # Imposta permessi
          sudo chown -R www-datawww-data varwwwmyfamilydoc
          sudo chmod -R 755 varwwwmyfamilydoc
          sudo find varwwwmyfamilydoc -type f -exec chmod 644 {} ;
          
          # Cleanup
          rm -rf tmpfrontend-deploy
          
          # Verifica
          echo âœ… Deploy completed!
          ls -lah varwwwmyfamilydoc

    # 9. Notification
    - name âœ… Success
      if success()
      run 
        echo ğŸ‰ Deploy successful!
        echo ğŸŒ Visit httpstest.myfamilydoc.it
